<!DOCTYPE html>
<html lang="en-EN">
	<head>
		<script type="text/javascript" src="modified-binary-search.js"></script>
		<script type="text/javascript" src="formulas.js"></script>
		<script type="text/javascript" src="bpm-timeline.js"></script>
		<script type="text/javascript" src="d3.v2.js"></script>
		<script type="text/javascript" src="create-d3-xy-graph.js"></script>
		<link 	type="text/css" rel="stylesheet" href="style.css"></link>
	</head>
	<body>
		<h3>Beat to Time</h3>
		<div id="graph1" class="aGraph" style=""></div>
		<h3>Time to Beat</h3>
		<div id="graph2" class="aGraph" style=""></div>
		<h3>Value at Beat</h3>
		<div id="graph3" class="aGraph" style=""></div>
		<h3>Value at Time</h3>
		<div id="graph3" class="aGraph" style=""></div>

		<script type="text/javascript">

			// define dimensions of graph
			var m = [0, 0, 20, 80]; // margins
			var w = 600 - m[1] - m[3]; // width
			var h = 400 - m[0] - m[2]; // height

			d3.select("#graph1")
				.append("svg:svg")
					.attr("width", w + m[1] + m[3])
					.attr("height", h + m[0] + m[2]);

			d3.select("#graph2")
				.append("svg:svg")
					.attr("width", w + m[1] + m[3])
					.attr("height", h + m[0] + m[2]);

			d3.select("#graph3")
				.append("svg:svg")
					.attr("width", w + m[1] + m[3])
					.attr("height", h + m[0] + m[2]);

			d3.select("#graph4")
				.append("svg:svg")
					.attr("width", w + m[1] + m[3])
					.attr("height", h + m[0] + m[2]);


			var automation = new BPMTimeline(60);
			automation.add_bpm_marker({type: "linear", endBeat: 50,  endBPM : 120    });
			automation.add_bpm_marker({type: "linear", endBeat: 100, endBPM : 140   });
			automation.add_bpm_marker({type: "linear", endBeat: 120, endBPM : 50    });
			automation.add_bpm_marker({type: "linear", endBeat: 125, endBPM : 10    });
			automation.add_bpm_marker({type: "linear", endBeat: 130, endBPM : 1000   });
			// automation.add_bpm_marker({type: "linear", endBeat: 160, endBPM : -200  });
			// automation.add_bpm_marker({type: "linear", endBeat: 200, endBPM : -1800 });
			// automation.add_bpm_marker({type: "linear", endBeat: 250, endBPM : -100  });

			var datasets = {
				timeAtBeat : [],
				beatAtTime : [],
				valueAtTime: []
			};
			var markers = automation.get_markers();
			for (var mi in markers)
				markers[mi].color = random_color_v2();

			// Create "timeAtBeat" dataset
			var xmax = markers[markers.length-1].endBeat;
			for (var mi in markers) {

				console.log("----------mi:"+mi+"--------------");

				var arr1 = [];
				var arr2 = [];

				var Ms = markers[mi];

				for (var x=(Ms.previous)?Ms.previous.endBeat:0; x<=Ms.endBeat; x+=0.1) {
					var time = automation.time(x);
					var beat = automation.beat(time);
					arr1.push({
						x: x, 
						y: time
					});
					arr2.push({
						x: x,
						y: beat
					});
				}

				arr1.color = arr2.color = Ms.color;
				
				datasets.timeAtBeat.push(arr1);
				datasets.beatAtTime.push(arr2);

			}

			var ymax = automation.time(markers[markers.length-1].endBeat);

			create_d3_xy_graph("graph1", w, h, m, datasets.timeAtBeat, xmax+50, ymax+100);
			create_d3_xy_graph("graph2", w, h, m, datasets.beatAtTime, xmax+50, ymax+100);

			function random_color_v2() {
				return 'rgb(' + [
					~~(Math.random() * 255),
					~~(Math.random() * 255),
					~~(Math.random() * 255)
				] + ')';
			}
		</script>
	</body>
</html>